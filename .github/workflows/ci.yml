name: Vortex GPU Audio Backend CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily 2 AM build

env:
  BUILD_TYPE: Release
  CUDA_ARCHITECTURES: 86

jobs:
  build-cpu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libasound2-dev \
          libpulse-dev \
          libflac-dev \
          libvorbis-dev \
          libmp3lame-dev \
          libsndfile1-dev \
          libfftw3-dev \
          libopencl-dev

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-1-${{ env.CACHE_VERSION }}

    - name: Build (CPU only)
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DWITHOUT_GPU=ON
        make -j$(nproc)

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

  build-gpu:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[gpu-test]')
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: |
        docker buildx build \
          --platform linux/amd64 \
          --tag vortex-audio-backend:latest \
          --push ${{ github.event_name != 'pull_request' }} \
          .

    - name: Run GPU tests in container
      run: |
        docker run --rm --gpus all \
          vortex-audio-backend:latest \
          /usr/local/bin/vortex-tests

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          cppcheck \
          rustc

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-1-rust

    - name: Lint C++ code
      run: |
        find . -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror
        find . -name "*.cpp" -o -name "*.hpp" | xargs clang-tidy --dry-run
        cppcheck --error-exitcode=1 src/

    - name: Lint Rust code
      run: |
        cd vortex-backend
        cargo check --all-targets
        cargo clippy -- -D warnings

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Run security scan
      run: |
        # Use container-based security scanner if available
        echo "Security scan would run here"

    - name: Check for vulnerabilities
      run: |
        # Check for known vulnerabilities in dependencies
        echo "Vulnerability check would run here"

  performance-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')
    needs: build-cpu
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libasound2-dev \
          libpulse-dev \
          libflac-dev \
          libvorbis-dev \
          libmp3lame-dev \
          libsndfile1-dev \
          libfftw3-dev

    - name: Build with performance optimizations
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
          -DNDEBUG
        make -j$(nproc)

    - name: Run performance benchmarks
      run: |
        cd build
        ./vortex-backend --benchmark --duration=30